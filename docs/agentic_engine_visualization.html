<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentic Engine - Junction25</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            padding: 40px 20px;
            line-height: 1.5;
        }
        
        .diagram-section {
            margin-bottom: 80px;
            page-break-inside: avoid;
        }
        
        .diagram-section:last-child {
            margin-bottom: 0;
        }
        
        .mermaid {
            background: transparent;
            padding: 0;
            margin: 0;
        }
        
        @media print {
            body {
                padding: 20px;
            }
            .diagram-section {
                margin-bottom: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="diagram-section">
        <div class="mermaid">
flowchart TB
    Start([Document Upload]) --> Extract[Document Extraction]
    Extract --> Chunk[Semantic Chunking]
    Chunk --> Embed[Generate Embeddings]
    Embed --> Index[Vector Store Indexing]
    Index --> Queue[Queue Audit]
    Queue --> Runner[Compliance Runner]
    Runner --> ProcessChunk{For Each Chunk}
    ProcessChunk --> BuildContext[Build RAG Context]
    BuildContext --> Analyze[LLM Analysis]
    Analyze --> Refine{Needs More Context?}
    Refine -->|Yes| BuildContext
    Refine -->|No| Flag[Generate Flag]
    Flag --> Store[Store Result]
    Store --> MoreChunks{More Chunks?}
    MoreChunks -->|Yes| ProcessChunk
    MoreChunks -->|No| Aggregate[Aggregate Results]
    Aggregate --> Report[Generate Report]
    Report --> Export[Export Report]
    Export --> End([Complete])
    
    style Start fill:#f0f9ff,stroke:#0284c7,stroke-width:2px
    style End fill:#f0fdf4,stroke:#16a34a,stroke-width:2px
    style Runner fill:#fefce8,stroke:#ca8a04,stroke-width:2px
    style Analyze fill:#fef2f2,stroke:#dc2626,stroke-width:2px
    style Report fill:#f0f9ff,stroke:#0284c7,stroke-width:2px
        </div>
    </div>
    
    <div class="diagram-section">
        <div class="mermaid">
flowchart TD
    Start([Start Audit]) --> BuildContext[Build RAG Context]
    BuildContext --> ManualRAG[Retrieve Manual Neighbors]
    BuildContext --> RegRAG[Retrieve Regulations]
    BuildContext --> GuideRAG[Retrieve AMC/GM]
    BuildContext --> EvidenceRAG[Retrieve Evidence]
    ManualRAG --> Combine[Combine Contexts]
    RegRAG --> Combine
    GuideRAG --> Combine
    EvidenceRAG --> Combine
    Combine --> LLMAnalysis[LLM Analysis]
    LLMAnalysis --> CheckRefine{Needs Additional Context?}
    CheckRefine -->|Yes| RefineRAG[Targeted RAG Search]
    RefineRAG --> LLMAnalysis
    CheckRefine -->|No| Score[Score & Flag]
    Score --> StoreResult[Store Result]
    StoreResult --> More{More Chunks?}
    More -->|Yes| BuildContext
    More -->|No| Complete([Audit Complete])
    
    style Start fill:#f0f9ff,stroke:#0284c7,stroke-width:2px
    style Complete fill:#f0fdf4,stroke:#16a34a,stroke-width:2px
    style LLMAnalysis fill:#fef2f2,stroke:#dc2626,stroke-width:2px
    style Score fill:#fefce8,stroke:#ca8a04,stroke-width:2px
    style BuildContext fill:#f0f9ff,stroke:#0284c7,stroke-width:2px
        </div>
    </div>
    
    <div class="diagram-section">
        <div class="mermaid">
flowchart TB
    Start([Focus Chunk]) --> BaseRAG[Base RAG Context]
    BaseRAG --> ExtractRefs[Extract Section References]
    ExtractRefs --> RefQueue{Reference Queue}
    RefQueue -->|Empty| BaseContext[Base Context Ready]
    RefQueue -->|Has Refs| ProcessRef[Process Reference]
    ProcessRef --> CheckDepth{Depth < Max?}
    CheckDepth -->|No| SkipRef[Skip Reference]
    CheckDepth -->|Yes| RAGRef[RAG for Reference]
    RAGRef --> ExtractRefs2[Extract References from Result]
    ExtractRefs2 --> AddToQueue[Add to Queue]
    AddToQueue --> RefQueue
    SkipRef --> RefQueue
    BaseContext --> FindLitigation[Find Related Litigation]
    FindLitigation --> LitQueue{Litigation Queue}
    LitQueue -->|Empty| FinalContext[Final Context Bundle]
    LitQueue -->|Has Lit| ProcessLit[Process Litigation]
    ProcessLit --> RAGLit[RAG for Litigation]
    RAGLit --> ExtractLitRefs[Extract References]
    ExtractLitRefs --> AddLitToQueue[Add to Queue]
    AddLitToQueue --> LitQueue
    FinalContext --> Bundle[Context Bundle]
    Bundle --> TokenBudget[Apply Token Budget]
    TokenBudget --> Truncate{Exceeds Budget?}
    Truncate -->|Yes| Trim[Trim Low-Score Slices]
    Truncate -->|No| Ready[Context Ready]
    Trim --> Ready
    
    style Start fill:#f0f9ff,stroke:#0284c7,stroke-width:2px
    style Ready fill:#f0fdf4,stroke:#16a34a,stroke-width:2px
    style RAGRef fill:#fefce8,stroke:#ca8a04,stroke-width:2px
    style RAGLit fill:#fefce8,stroke:#ca8a04,stroke-width:2px
    style Bundle fill:#f0f9ff,stroke:#0284c7,stroke-width:2px
        </div>
    </div>
    
    <div class="diagram-section">
        <div class="mermaid">
flowchart LR
    Chunk[Focus Chunk] --> VectorSearch[Vector Search]
    VectorSearch --> ManualSearch[Manual Collection]
    VectorSearch --> RegSearch[Regulation Collection]
    VectorSearch --> GuideSearch[AMC/GM Collection]
    VectorSearch --> EvidenceSearch[Evidence Collection]
    ManualSearch --> ManualResults[Top-K Manual Neighbors]
    RegSearch --> RegResults[Top-K Regulations]
    GuideSearch --> GuideResults[Top-K Guidance]
    EvidenceSearch --> EvidenceResults[Top-K Evidence]
    ManualResults --> Bundle[Context Bundle]
    RegResults --> Bundle
    GuideResults --> Bundle
    EvidenceResults --> Bundle
    Bundle --> TokenCount[Calculate Tokens]
    TokenCount --> BudgetCheck{Within Budget?}
    BudgetCheck -->|No| SortByScore[Sort by Relevance Score]
    BudgetCheck -->|Yes| Ready[Ready for Analysis]
    SortByScore --> TrimLow[Trim Low-Score Slices]
    TrimLow --> Ready
    
    style Chunk fill:#f0f9ff,stroke:#0284c7,stroke-width:2px
    style Ready fill:#f0fdf4,stroke:#16a34a,stroke-width:2px
    style Bundle fill:#f0f9ff,stroke:#0284c7,stroke-width:2px
    style VectorSearch fill:#fefce8,stroke:#ca8a04,stroke-width:2px
        </div>
    </div>
    
    <div class="diagram-section">
        <div class="mermaid">
flowchart TD
    Start([Chunk + Context Bundle]) --> BuildPrompt[Build Analysis Prompt]
    BuildPrompt --> LLMCall[Call OpenRouter LLM]
    LLMCall --> ParseJSON[Parse JSON Response]
    ParseJSON --> Validate{Valid JSON?}
    Validate -->|No| Retry[Retry with Error]
    Retry --> LLMCall
    Validate -->|Yes| ExtractFlag[Extract Flag & Findings]
    ExtractFlag --> CheckContext{needs_additional_context?}
    CheckContext -->|No| Finalize[Finalize Analysis]
    CheckContext -->|Yes| CheckAttempts{Attempts < Max?}
    CheckAttempts -->|No| Finalize
    CheckAttempts -->|Yes| ExtractQuery[Extract context_query]
    ExtractQuery --> CheckQuery{Query Provided?}
    CheckQuery -->|No| Finalize
    CheckQuery -->|Yes| RefineRAG[Refined RAG Search]
    RefineRAG --> ExpandContext[Expand Context Bundle]
    ExpandContext --> BuildPrompt
    Finalize --> Score[Calculate Severity Score]
    Score --> Citations[Extract Citations]
    Citations --> Recommendations[Generate Recommendations]
    Recommendations --> Result[Analysis Result]
    Result --> Store[Store in Database]
    Store --> End([Complete])
    
    style Start fill:#f0f9ff,stroke:#0284c7,stroke-width:2px
    style End fill:#f0fdf4,stroke:#16a34a,stroke-width:2px
    style LLMCall fill:#fef2f2,stroke:#dc2626,stroke-width:2px
    style RefineRAG fill:#fefce8,stroke:#ca8a04,stroke-width:2px
    style Result fill:#f0f9ff,stroke:#0284c7,stroke-width:2px
        </div>
    </div>
    
    <div class="diagram-section">
        <div class="mermaid">
flowchart TB
    subgraph "Phase 1: Document Ingestion"
        A1[Upload Document] --> A2[Extract Text]
        A2 --> A3[Parse Structure]
        A3 --> A4[Chunk Document]
        A4 --> A5[Generate Embeddings]
        A5 --> A6[Index in Vector Store]
    end
    
    subgraph "Phase 2: Audit Execution"
        B1[Create Audit] --> B2[Queue Audit]
        B2 --> B3[Compliance Runner]
        B3 --> B4[For Each Chunk]
    end
    
    subgraph "Phase 3: Chunk Analysis"
        C1[Build RAG Context] --> C2[Recursive RAG]
        C2 --> C3[LLM Analysis]
        C3 --> C4{Needs Refinement?}
        C4 -->|Yes| C5[Refined RAG]
        C5 --> C3
        C4 -->|No| C6[Generate Flag]
    end
    
    subgraph "Phase 4: Result Aggregation"
        D1[Store Chunk Result] --> D2[Upsert Flag]
        D2 --> D3[Update Progress]
        D3 --> D4{More Chunks?}
        D4 -->|Yes| B4
        D4 -->|No| D5[Aggregate Results]
    end
    
    subgraph "Phase 5: Report Generation"
        E1[Calculate Statistics] --> E2[Generate Executive Summary]
        E2 --> E3[Generate Detailed Findings]
        E3 --> E4[Generate Recommendations]
        E4 --> E5[Export Report]
    end
    
    A6 --> B1
    B4 --> C1
    C6 --> D1
    D5 --> E1
    E5 --> F([Audit Complete])
    
    style A1 fill:#f0f9ff,stroke:#0284c7,stroke-width:2px
    style F fill:#f0fdf4,stroke:#16a34a,stroke-width:2px
    style C3 fill:#fef2f2,stroke:#dc2626,stroke-width:2px
    style C6 fill:#fefce8,stroke:#ca8a04,stroke-width:2px
    style E5 fill:#f0f9ff,stroke:#0284c7,stroke-width:2px
        </div>
    </div>
    
    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'base',
            themeVariables: {
                primaryColor: '#ffffff',
                primaryTextColor: '#1f2937',
                primaryBorderColor: '#3b82f6',
                lineColor: '#6b7280',
                secondaryColor: '#f9fafb',
                tertiaryColor: '#f3f4f6',
                background: '#ffffff',
                mainBkg: '#ffffff',
                secondBkg: '#ffffff',
                textColor: '#1f2937',
                edgeLabelBackground: '#ffffff',
                clusterBkg: '#f9fafb',
                clusterBorder: '#e5e7eb',
                defaultLinkColor: '#3b82f6',
                titleColor: '#1f2937',
                nodeBorder: '#3b82f6',
                nodeTextColor: '#1f2937'
            },
            flowchart: {
                curve: 'basis',
                padding: 20,
                nodeSpacing: 50,
                rankSpacing: 80,
                useMaxWidth: true
            }
        });
    </script>
</body>
</html>
